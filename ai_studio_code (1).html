<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lua Edit</title>
    
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/lua/lua.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/selection/active-line.min.js"></script>

    <style>
        body {
            margin: 0; padding: 0;
            background: #fff; color: #333;
            height: 100vh; 
            display: flex; flex-direction: column;
            overflow: hidden;
            font-family: -apple-system, sans-serif;
        }

        /* --- Toolbar --- */
        #toolbar {
            height: 40px;
            background: #f9f9f9;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 8px; /* ระยะห่างระหว่างปุ่ม */
            flex-shrink: 0;
            white-space: nowrap; /* ห้ามตัดบรรทัดเด็ดขาด */
            overflow-x: auto; /* ถ้าจอเล็กมากให้เลื่อนแนวนอนแทนการขึ้นบรรทัดใหม่ */
        }

        .brand {
            font-weight: bold;
            font-size: 14px;
            margin-right: 10px;
            text-transform: uppercase;
            flex-shrink: 0; /* ห้ามชื่อหด */
        }

        /* ปุ่มทุกปุ่มสไตล์เดียวกันหมด */
        button {
            background: #fff;
            border: 1px solid #ccc;
            color: #333;
            padding: 4px 8px; /* ปรับขนาดให้กระชับ */
            font-size: 12px;
            cursor: pointer;
            border-radius: 3px;
            flex-shrink: 0; /* ห้ามปุ่มหด */
        }

        button:hover {
            background: #f0f0f0;
            border-color: #999;
        }

        /* --- Editor --- */
        #editor-wrapper {
            flex-grow: 1; 
            position: relative;
            overflow: hidden;
            height: calc(100vh - 62px); 
        }

        .CodeMirror {
            height: 100% !important;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .cm-s-default .cm-keyword { color: #d73a49; font-weight: bold; }
        .cm-s-default .cm-string { color: #032f62; }
        .cm-s-default .cm-number { color: #005cc5; }
        .cm-s-default .cm-comment { color: #6a737d; font-style: italic; }

        .CodeMirror-gutters { background: #f5f5f5; border-right: 1px solid #eee; }
        .CodeMirror-linenumber { color: #999; }
        .CodeMirror-selected { background: #e0e0e0 !important; }

        /* Overlays */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: none;
            justify-content: center; align-items: center;
            z-index: 100;
            flex-direction: column;
            border: 2px dashed #ccc;
        }
        
        .modal {
            background: #fff; border: 1px solid #ccc; padding: 20px;
            text-align: center; width: 320px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .modal p { margin: 0 0 10px 0; font-weight: bold; font-size: 14px; }
        .link-input { width: 100%; padding: 6px; margin-bottom: 15px; border: 1px solid #ddd; font-family: monospace; font-size: 12px; }

        /* --- Status Bar --- */
        #statusbar {
            height: 22px; 
            border-top: 1px solid #ddd;
            display: flex; align-items: center; padding: 0 10px;
            font-size: 11px; color: #666; justify-content: space-between;
            flex-shrink: 0;
            background: #fff;
        }

        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div id="toolbar">
        <div class="brand">Lua Edit</div>
        <!-- ชื่อปุ่มตามสั่งเป๊ะ -->
        <button onclick="document.getElementById('fileInput').click()">File</button>
        <button onclick="saveFile()">Save</button>
        <button onclick="clearCode()">Clear</button>
        <button onclick="createLink()">Link</button>
        <button onclick="obfuscateCode()">Obf</button>
        
        <input type="file" id="fileInput" accept=".lua,.txt">
    </div>

    <div id="editor-wrapper">
        <div id="overlay">
            <h3 id="overlay-text">Drop File</h3>
            <!-- Link Modal -->
            <div id="link-modal" style="display:none;" class="modal">
                <p>Get Raw Link</p>
                <input type="text" class="link-input" id="link-result" readonly>
                <div style="display:flex; justify-content:center; gap:10px;">
                    <button onclick="copyLink()">Copy</button>
                    <button onclick="closeOverlay()">Close</button>
                </div>
            </div>
        </div>
        <textarea id="code-area">print("Hello Roblox")</textarea>
    </div>

    <div id="statusbar">
        <span id="status">Ready</span>
        <span id="cursor">Ln 1, Col 1</span>
    </div>

    <script>
        // Setup Editor
        var editor = CodeMirror.fromTextArea(document.getElementById("code-area"), {
            mode: "lua", theme: "default", lineNumbers: true,
            autoCloseBrackets: true, styleActiveLine: true, indentUnit: 4
        });
        editor.setSize("100%", "100%");

        editor.on("cursorActivity", () => {
            var pos = editor.getCursor();
            document.getElementById("cursor").innerText = "Ln " + (pos.line + 1) + ", Col " + (pos.ch + 1);
        });

        // File Open
        document.getElementById('fileInput').onchange = (e) => {
            if(e.target.files[0]) readFile(e.target.files[0]);
            e.target.value = '';
        };

        // Drag & Drop
        const overlay = document.getElementById('overlay');
        const overlayText = document.getElementById('overlay-text');
        const linkModal = document.getElementById('link-modal');

        window.ondragover = (e) => { e.preventDefault(); overlay.style.display = 'flex'; overlayText.style.display='block'; linkModal.style.display='none'; };
        window.ondragleave = (e) => { if(e.clientX===0||e.clientY===0) overlay.style.display='none'; };
        window.ondrop = (e) => {
            e.preventDefault(); overlay.style.display='none';
            if(e.dataTransfer.files[0]) readFile(e.dataTransfer.files[0]);
        };

        function readFile(file) {
            const r = new FileReader();
            r.onload = (e) => { editor.setValue(e.target.result); setStatus("Loaded"); };
            r.readAsText(file);
        }

        // Save
        function saveFile() {
            const blob = new Blob([editor.getValue()], {type: "text/plain"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "script.lua";
            a.click();
            setStatus("Saved");
        }

        // Clear
        function clearCode() {
            editor.setValue("");
            setStatus("Cleared");
        }

        // Obfuscate (Logic เดิม ไม่พัง)
        function obfuscateCode() {
            const src = editor.getValue();
            if(!src.trim()) return setStatus("No code");
            
            setStatus("Processing...");
            
            const k = Math.floor(Math.random()*100)+50;
            let c = [];
            for(let i=0; i<src.length; i++) {
                let e = (src.charCodeAt(i) + k) % 256;
                let s = e.toString();
                while(s.length<3) s="0"+s;
                c.push("\\"+s);
            }
            
            // Generate valid variable names
            const rV = () => 'v'+Math.random().toString(36).substring(7);
            const vD=rV(), vF=rV(), vK=rV();
            
            const payload = `local ${vK}=${k} local ${vD}="${c.join('')}" local function ${vF}(s) local r="" for i=1,#s do local b=string.byte(s,i,i) r=r..string.char((b-${vK})%256) end return r end loadstring(${vF}(${vD}))()`;
            
            editor.setValue(payload);
            setStatus("Obfuscated");
        }

        // Link
        async function createLink() {
            const code = editor.getValue();
            if(!code.trim()) return setStatus("Empty");

            overlay.style.display = 'flex';
            overlayText.style.display = 'none';
            linkModal.style.display = 'block';
            
            const input = document.getElementById('link-result');
            input.value = "Just a moment..."; 

            try {
                const req = await fetch("https://pastefy.app/api/v2/paste", {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({title:"Lua Script", content:code})
                });
                if(!req.ok) throw new Error();
                const res = await req.json();
                
                input.value = `https://pastefy.app/${res.paste.id}/raw`;
                input.select();
                
            } catch(e) {
                input.value = "Error";
            }
        }

        function copyLink() {
            document.getElementById('link-result').select();
            document.execCommand('copy');
            setStatus("Link Copied");
        }

        function closeOverlay() {
            overlay.style.display = 'none';
        }

        function setStatus(msg) {
            document.getElementById('status').innerText = msg;
            setTimeout(() => document.getElementById('status').innerText = "Ready", 2000);
        }
    </script>
</body>
</html>